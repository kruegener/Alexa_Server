{% extends "AlexaHandler/base.html" %}
{% load static %}

{% block head %}

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        html{
            min-height:100%;/* make sure it is at least as tall as the viewport */
            position:relative;
        }
        body {
            height:100%;
            scroll-behaviour: smooth;
        }

        #bar {
            padding-left: 1em;
            display:block;
            overflow:auto;
            height: 20vh;
            width: 80vw;
            top: 0;
            left: 0;
            background-color: #f7f3ff;
        }

        #plumbing_block {
            padding-left: 1em;
            display:block;
        //overflow:hidden;
            height: 80vh;
            width: 80vw;
            left: 0;
            top: 20vh;
            background-color: #f7fff0;
        }

        h2 {
            padding-left: 10%;
        }
        img {

            max-width:100%;
            //margin-bottom: 10%;
            z-index:10;
        }
        .window { z-index:20; }
        .jtk-connector { z-index:4; }
        .jtk-endpoint { z-index:11; }
        .jtk-overlay { z-index:12; }

        p.content {
            overflow:hidden;
            background-color: rgba(27, 1, 255, .1);
        }

        p.num {
            position:absolute;
            width: 20px;
            bottom: -20px;
            left: -12px;
        }

        .opt-bar {
            overflow:auto;
            position:fixed;
            padding:20px;
            overflow-y: auto;
            right: 0;
            left: 80vw;
            height:100vh;
            top: 0;
            background-color: #ffcad6;
        }

        .var-list {
            background-color: #fbfbfc;
        }

        .item_var {
            background-color: rgba(27, 1, 255, 0.16);
        }

        div.content {
            background-color: rgba(27, 1, 255, .1);
            position:relative;
        }

        #button_group {
            position:absolute;
            bottom:0;
        }

        button.number {
            margin-top:auto;
            font-weight:bold;
            background-color: rgba(255, 235, 209, .5);
            z-index: 99 !important;
        }
        button.func {
            font-weight:bold;
            background-color: rgba(200,200,200, .5);
        }


    </style>
    <!-- jQuery -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-latest.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <!-- material design -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

    <!-- local files -->
    <script src="{% static "AlexaHandler/jsplumb.min.js" %}"></script>
    <script src="{% static "AlexaHandler/reconnecting-websocket.min.js" %}"></script>

    <!-- check for jquery -->
    <script type="text/javascript">

        (function defer() {
            if (window.jQuery) {
                //alert("jQuery loaded");
            } else {
                console.log("check");
                setTimeout(function() { defer() }, 50);
            }
        })();

    </script>

    <!-- socket and block scripts -->
    <script type="text/javascript">
        console.log("in local script");
        //
        //alert("my own");
        window.onload = function()
        {
            if (!window.jQuery) {
                alert('jQuery is not loaded');
            }
        }

        var plumbing = jsPlumb.getInstance();
        var last_name = "";
        var grid_count = 0;
        var width = $(window).width()*.8;
        var height = $(window).height();
        var xStep = 220;
        var yStep = 220;
        var xGrid = Math.floor( (width)/xStep);
        var init = true;

        plumbing.importDefaults({
            ConnectionsDetachable:false,
            ReattachConnections:true
        });
        // make containment specific

        var dynamicAnchors = ["Left", "Right", "Top", "Bottom"];

        var common = {detachable:false,
            anchor:dynamicAnchors,
            connector: ["Bezier", {
                curviness:50,
            }],
            endpoint:[ "Rectangle", {
                cssClass:"myEndpoint",
                width:10,
                height:10
            }],};

        function new_plumb(){
            //jsPlumb block
            console.log("new_plumb started");
            plumbing.draggable($(".draggable"), {
                containment:"plumbing_block"
            });
        }
        var environ = "{{ ENV }}"
        {% if environ == "LOCAL" %}
            // LOCAL VERSION
            var socket = new ReconnectingWebSocket("ws://localhost:8000/alexa/");
        {% else %}
            // SERVER VERSION
            var socket = new ReconnectingWebSocket("wss://talktoyourdata.upc.edu/alexa/");
        {% endif %}
        //alert(socket.readyState);
        socket.debug = true;
        var msg_count = 0;
        var block_count = 0;

        function new_grid_block(data){
            console.log("grid update called");
            console.log("JSON", data);
            name = "grid_" + "block" + block_count;
            block_count += 1;
            console.log(xGrid, grid_count);
            yOff = height*.2;
            xOff = 20;
            var div = document.createElement("div");
            div.id = name;
            div.className = "content mdl-cell mdl-cell--3-col";

            // add vars
            if(data.hasOwnProperty("vars")){
                new_Var(data.vars, grid_count);
            }

            if (data.block_type == "message"){
                var p = document.createElement("p");
                p.className = "content";
                p.appendChild(document.createTextNode(data.block_type));
                p.appendChild(document.createElement("br"));
                p.appendChild(document.createTextNode(data.block_id));
                p.appendChild(document.createElement("br"));
                p.appendChild(document.createTextNode(data.msg));
                div.appendChild(p);
            }
            else if (data.block_type == "image") {
                var img = document.createElement("img");
                img.src = data.call_path;
                div.appendChild(img);
            }
            else if (data.block_type == "histogram") {
                var img = document.createElement("img");
                img.src = data.call_path;
                div.appendChild(img);
            }
            else {
                console.log(data);
            }

            var but_group = document.createElement("div");
            but_group.id = "button_group";
            but_group.className = "button_group";
            // add number
            var number = document.createElement("button");
            number.className = "number mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--raised";
            number.disabled = false;
            number.textContent = grid_count;
            but_group.appendChild(number);
            // add options
            var opt = 0;

            for(opt = 0; opt < data.options.length; opt++){
                console.log("OPTION: ", data.options[opt]);
                var but = document.createElement("button");
                but.id = name + "_" + opt;
                but.className = "func mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--raised";
                jQuery.data( but, "call", {
                    num: block_count - 1,
                    opt: data.options[opt]
                });
                but.onclick = function(but){
                    socket.send(JSON.stringify({"type" : "command",
                        "cmd" : "click",
                        "num" : jQuery.data( this, "call" ).num,
                        "opt" : jQuery.data( this, "call" ).opt
                    }));
                };
                jQuery.data( but, "call", {
                    num: block_count - 1,
                    opt: data.options[opt]
                });
                console.log(jQuery.data( but, "call" ).opt);
                console.log(jQuery.data( but, "call" ).num);
                but.innerHTML = (data.options[opt]);
                but_group.appendChild(but);
                console.log($(but));

            }
            grid_count += 1;
            last_name = name;

            div.appendChild(but_group);
            var par = document.getElementById("grid");
            $(par).append(div);
            try {
                console.log("ifNeeded works");
                div.scrollIntoViewIfNeeded(true);
            }
            catch(err)
            {
                console.log("ifNeeded doesnt work");
                div.scrollIntoView(true);
            }
            componentHandler.upgradeDom();
            // refresh clickable

        }

        function reset(){
            //plumbing.empty("plumbing_block");
            last_name = "";
            grid_count = 0;
            block_count = 0;
            var_num = 0;
            document.getElementById("var_body").innerHTML = "";
            document.getElementById("grid").innerHTML = "";
            componentHandler.upgradeDom();
        }

        function send_reset(){
            socket.send(JSON.stringify({"type" : "command", "cmd" : "del_all"}));
        }

        function send_populate_hist(){
            socket.send(JSON.stringify({"type" : "histogram", "msg" : "message content"}));
        }

        function send_populate_msg(){
            socket.send(JSON.stringify({"type" : "msg", "msg" : "message content"}));
        }

        function send_image_populate(){
            socket.send(JSON.stringify({"type" : "command", "cmd" : "img"}));
        }

        function light_up(data){
            name = "draggable_block" + data.block_id;
            $( "#" + name ).effect("highlight", {}, 3000);
        }

        function showBlock(data) {
            window.open(data.call_path);
        }

        var var_num = 0;

        function new_Gen_Var() {
            var outer = document.getElementById("Vars");
            var table = document.getElementById("var_body");
            var row = table.insertRow();

            // checkbox cell
            var check = row.insertCell();
            var checkbox = '<label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect mdl-data-table__select" for="row[' + var_num + ']"><input type="checkbox" id="row[' + var_num + ']" class="mdl-checkbox__input" /></label>';
            check.innerHTML = checkbox;
            // num cell
            var cell = row.insertCell();
            cell.className = "mdl-data-table__cell";
            cell.textContent = var_num;
            // content cell
            var cell = row.insertCell();
            cell.className = "mdl-data-table__cell--non-numeric";
            cell.textContent = "varname" + var_num;
            // block cell
            var cell = row.insertCell();
            cell.className = "mdl-data-table__cell";
            cell.textContent = "###";
            var_num++;
            componentHandler.upgradeDom();
            cell.scrollIntoView();
        }

        function new_Var(list, block_num) {
            var outer = document.getElementById("Vars");
            var table = document.getElementById("var_body");
            for(i = 0; i < list.length; i++){
                var row = table.insertRow();
                // checkbox cell
                var check = row.insertCell();
                var checkbox = '<label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect mdl-data-table__select" for="row[' + var_num + ']"><input type="checkbox" id="row[' + var_num + ']" class="mdl-checkbox__input" /></label>';
                check.innerHTML = checkbox;
                // num cell
                var cell = row.insertCell();
                cell.className = "mdl-data-table__cell";
                cell.textContent = var_num;
                // content cell
                var cell = row.insertCell();
                cell.className = "mdl-data-table__cell--non-numeric";

                cell.textContent = list[i];
                // block cell
                var cell = row.insertCell();
                cell.className = "mdl-data-table__cell";
                cell.textContent = block_num;
                var_num++;
            }
            componentHandler.upgradeDom();
        }

        socket.onmessage = function(e) {
            console.log(e.data);
            data = JSON.parse(e.data);
            console.log(data.type);

            // maybe somewhere else


            if (data.type == "block") {
                if(init){
                    init = false;
                    document.getElementById("progress").remove();
                }
                //new_block(data);
                new_grid_block(data);
            }
            else if (data.type == "cmd") {
                if(data.cmd == "reset"){
                    reset();
                }
                else if(data.cmd == "ready") {
                    if(init)
                        socket.send(JSON.stringify({"type": "command", "cmd": "init"}));
                }
                else if(data.cmd == "init_done") {
                    init = false;
                    document.getElementById("progress").remove();
                }
                else if(data.cmd == "light_up") {
                    light_up(data);
                }
                else if(data.cmd == "show") {
                    showBlock(data);
                }
            }

            plumbing.draggable($(".draggable") , {
                containment:"plumbing_block"
            });

        }

        socket.onopen = function(e){
            console.log("socket is open");
        };

        $( document ).ready(function() {
            console.log( "ready!" );
            // var header select
            var table = document.getElementById("Vars");
            var headerCheckbox = table.querySelector('thead .mdl-data-table__select input');
            var headerCheckHandler = function(event) {
                console.log("main checkbox clicked");
                var boxes = table.querySelectorAll('tbody .mdl-data-table__select');
                if (event.target.checked) {
                    for (var i = 0, length = boxes.length; i < length; i++) {
                        boxes[i].MaterialCheckbox.check();
                        //boxes[i].MaterialCheckbox.updateClasses();
                    }
                } else {
                    for (var i = 0, length = boxes.length; i < length; i++) {
                        boxes[i].MaterialCheckbox.uncheck();
                        //boxes[i].MaterialCheckbox.updateClasses();
                    }
                }
            };
            headerCheckbox.addEventListener('change', headerCheckHandler);

        });


    </script>
{% endblock %}

{% block body %}


    <div id = "bar">
        <h1> LIVE ALEXA Test</h1>
        <!-- Accent-colored raised button with ripple -->
        <button onclick="send_reset()" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored">
            Reset
        </button>
        <button onclick="send_populate_hist()" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
            Hist
        </button>
        <button onclick="send_populate_msg()" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
            Msg
        </button>
        <button onclick="new_Gen_Var()" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
            Var
        </button>
        <button onclick="send_image_populate()" class="mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab mdl-button--colored">
            <i class="material-icons">add</i>
        </button>
    </div>


    <div id ="plumbing_block">
        <!-- MDL Progress Bar with Indeterminate Progress -->

        <div id="progress" class="mdl-progress mdl-js-progress mdl-progress__indeterminate" style="top:30%; left: 20%"></div>
        <div id="grid" class="mdl-grid">

        </div>
    </div>

    <div class = "opt-bar">
        <h2> opt-bar </h2>
        <table id="Vars" class="var-list mdl-data-table mdl-shadow--2dp mdl-js-data-table">
            <thead>
            <tr>
                <th>
                    <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect mdl-data-table__select" for="main-check">
                        <input type="checkbox" id="main-check" class="mdl-checkbox__input" />
                    </label>
                </th>
                <th class="mdl-data-table__cell">#Var</th>
                <th class="mdl-data-table__cell--non-numeric">Name</th>
                <th class="mdl-data-table__cell">#Block</th>
            </tr>
            </thead>

            <tbody id="var_body">

            </tbody>
        </table>
    </div>



{% endblock %}
