{% extends "AlexaHandler/base.html" %}
{% load static %}

{% block head %}

    <meta name="viewport" content="width=device-width, initial-scale=1">


    <!-- jQuery -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-latest.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <!-- material design -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

    <!-- local files -->
    <script src="{% static "AlexaHandler/jsplumb.min.js" %}"></script>
    <script src="{% static "AlexaHandler/reconnecting-websocket.min.js" %}"></script>

    <style>
        html{
            min-height:100%;/* make sure it is at least as tall as the viewport */
            position:relative;
        }
        body {
            height:100%;
            scroll-behaviour: smooth;
        }


        #plumbing_block {
            padding-left: 1em;
            display:block;
            background-color: #f7fff0;
        }

        h2 {
            padding-left: 10%;
        }
        img {

            max-width:100%;
        //margin-bottom: 10%;
            z-index:10;
        }
        .window { z-index:20; }
        .jtk-connector { z-index:4; }
        .jtk-endpoint { z-index:11; }
        .jtk-overlay { z-index:12; }

        p.content {
            overflow:hidden;
            background-color: rgba(27, 1, 255, .1);
        }

        p.IO {
            overflow:hidden;
            padding: 5pt;
            background-color: #1b3249;
            color: white;
        }

        p.num {
            position:absolute;
            width: 20px;
            bottom: -20px;
            left: -12px;
        }


        .var-list {
            background-color: #fbfbfc;
        }

        div.content {
            background-color: rgba(27, 1, 255, .1);
            position:relative;
        }

        #button_group {
            position:relative;
            bottom:0;
        }

        button.number {
            margin-top:auto;
            font-weight:bold;
            background-color: rgba(255, 235, 209, .5);
            z-index: 99 !important;
        }
        button.func {
            font-weight:bold;
            background-color: rgba(200,200,200, .5);
        }

        #progress {
            position:absolute;
            align-self: center;
            top: 50%;
            left:50%;
        }


        .mdl-layout__drawer {
            width:auto;
        }
        .mdl-layout__drawer.is-visible {
            width:auto;
            left:0;
        }

        .logo {
            height:40pt;
            position: absolute;
            right: 10pt;
            top: 5pt;
        }

        #Sidebar {
            max-width: 30%;

        }
        #Sidebar.is-visible {
            max-width: 80%;

        }
        table {
            table-layout: fixed;
            max-width:100%;
        }

    </style>

    <!-- check for jquery -->
    <script type="text/javascript">

        (function defer() {
            if (window.jQuery) {
                //alert("jQuery loaded");
            } else {
                console.log("check");
                setTimeout(function() { defer() }, 50);
            }
        })();

    </script>

    <!-- socket and block scripts -->
    <script type="text/javascript">
        console.log("in local script");
        //
        //alert("my own");
        window.onload = function()
        {
            if (!window.jQuery) {
                alert('jQuery is not loaded');
            }
        }

        var plumbing = jsPlumb.getInstance();
        var last_name = "";
        var grid_count = 0;
        var width = $(window).width()*.8;
        var height = $(window).height();
        var xGrid = Math.floor( (width)/xStep);
        var xStep = 220;
        var init = true;
        var var_num = 0;
        var var_gen_num = 0;
        var file_num = 0;

        plumbing.importDefaults({
            ConnectionsDetachable:false,
            ReattachConnections:true
        });
        // make containment specific

        var dynamicAnchors = ["Left", "Right", "Top", "Bottom"];

        var common = {detachable:false,
            anchor:dynamicAnchors,
            connector: ["Bezier", {
                curviness:50,
            }],
            endpoint:[ "Rectangle", {
                cssClass:"myEndpoint",
                width:10,
                height:10
            }],};

        function new_plumb(){
            //jsPlumb block
            console.log("new_plumb started");
            plumbing.draggable($(".draggable"), {
                containment:"plumbing_block"
            });
        }
        var environ = "{{ ENV }}"
        {% if environ == "LOCAL" %}
            // LOCAL VERSION
            var socket = new ReconnectingWebSocket("ws://localhost:8000/alexa/");
        {% else %}
            // SERVER VERSION
            //var socket = new ReconnectingWebSocket("wss://talktoyourdata.upc.edu/alexa/");
            var socket = new ReconnectingWebSocket("ws://localhost:8000/alexa/");
        {% endif %}
        //alert(socket.readyState);
        socket.debug = true;
        var msg_count = 0;
        var block_count = 0;

        function new_grid_block(data){
            console.log("grid update called");
            console.log("JSON", data);
            name = "grid_" + "block" + block_count;
            block_count += 1;
            console.log(xGrid, grid_count);
            yOff = height*.2;
            xOff = 20;
            var div = document.createElement("div");
            div.id = name;
            div.className = "content mdl-cell mdl-cell--3-col mdl-shadow--6dp";

            // add vars
            if(data.hasOwnProperty("vars")){
                new_Var(data.vars, grid_count);
            }

            if (data.block_type == "message"){
                var p = document.createElement("p");
                p.className = "content";
                p.appendChild(document.createTextNode(data.block_type));
                p.appendChild(document.createElement("br"));
                p.appendChild(document.createTextNode(data.block_id));
                p.appendChild(document.createElement("br"));
                p.appendChild(document.createTextNode(data.msg));
                div.appendChild(p);
            }
            else if (data.block_type == "image") {
                var img = document.createElement("img");
                img.src = data.call_path;
                img.onclick = function() {
                    window.open(data.call_path);
                }
                div.appendChild(img);
            }
            else if (data.block_type == "histogram") {
                var img = document.createElement("img");
                img.src = data.call_path;
                img.onclick = function() {
                    window.open(data.call_path);
                };
                div.appendChild(img);
            }
            else if (data.block_type == "plot") {
                var img = document.createElement("img");
                console.log("PLOT:", data.call_path);
                img.src = data.call_path;
                var p = document.createElement("p");
                p.className = "IO mdl-shadow--6dp";
                p.appendChild(document.createTextNode(data.content_type));
                div.appendChild(img);
                div.appendChild(p);
            }
            else if (data.block_type == "IO") {
                var p = document.createElement("p");
                p.className = "IO mdl-shadow--6dp";
                p.appendChild(document.createTextNode("Type: " + data.block_type));
                p.appendChild(document.createElement("br"));
                p.appendChild(document.createTextNode("File Name: " + data.file_name));
                p.appendChild(document.createElement("br"));
                for(var item = 0; item < data.IO_data.length; item+=2){
                    p.appendChild(document.createTextNode(data.IO_data[item] + " " + data.IO_data[item+1]));
                    p.appendChild(document.createElement("br"));
                }

                div.appendChild(p);
            }
            else {
                console.log(data);
            }

            var but_group = document.createElement("div");
            but_group.id = "button_group";
            but_group.className = "button_group";
            // add number
            var number = document.createElement("button");
            number.className = "number mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--raised";
            number.disabled = false;
            number.textContent = grid_count;
            but_group.appendChild(number);
            // add options
            var opt = 0;

            for(opt = 0; opt < data.options.length; opt++){
                console.log("OPTION: ", data.options[opt]);
                var but = document.createElement("button");
                but.id = name + "_" + opt;
                but.className = "func mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--raised";
                jQuery.data( but, "call", {
                    num: block_count - 1,
                    opt: data.options[opt]
                });
                but.onclick = function(but){
                    socket.send(JSON.stringify({"type" : "command",
                        "cmd" : "click",
                        "num" : jQuery.data( this, "call" ).num,
                        "opt" : jQuery.data( this, "call" ).opt
                    }));
                };
                jQuery.data( but, "call", {
                    num: block_count - 1,
                    opt: data.options[opt]
                });

                but.innerHTML = (data.options[opt]);
                but_group.appendChild(but);


            }
            grid_count += 1;
            last_name = name;

            div.appendChild(but_group);
            var par = document.getElementById("grid");
            $(par).append(div);
            try {
                console.log("ifNeeded works");
                div.scrollIntoViewIfNeeded(true);
            }
            catch(err)
            {
                console.log("ifNeeded doesnt work");
                div.scrollIntoView(true);
            }
            componentHandler.upgradeDom();
            checkForSmallScreen();
            // refresh clickable

        }

        function reset(){
            //plumbing.empty("plumbing_block");
            last_name = "";
            grid_count = 0;
            block_count = 0;
            var_num = 0;
            var_gen_num = 0;
            file_num = 0;
            document.getElementById("var_body").innerHTML = "";
            document.getElementById("grid").innerHTML = "";
            componentHandler.upgradeDom();
            checkForSmallScreen();
        }

        function send_reset(){
            socket.send(JSON.stringify({"type" : "command", "cmd" : "del_all"}));
        }

        function send_populate_hist(){
            socket.send(JSON.stringify({"type" : "histogram", "msg" : "message content"}));
        }

        function send_populate_msg(){
            socket.send(JSON.stringify({"type" : "msg", "msg" : "message content"}));
        }

        function send_image_populate(){
            socket.send(JSON.stringify({"type" : "command", "cmd" : "img"}));
        }

        function light_up(data){
            name = "draggable_block" + data.block_id;
            $( "#" + name ).effect("highlight", {}, 3000);
        }

        function showBlock(data) {
            window.open(data.call_path);
        }



        function margin_adjust() {
            $(".mdl-layout__header").css("margin-left", $("#Sidebar").outerWidth());
            $(".mdl-layout__header").css("right", 0);
            $(".mdl-layout__content").css("margin-left", $("#Sidebar").outerWidth());
            $(".mdl-layout__drawer").css("left", 0);
        }

        function margin_small_adjust() {
            $(".mdl-layout__header").css("margin-left", 0);
            $(".mdl-layout__header").css("right", 0);
            $(".mdl-layout__content").css("margin-left", 0);
            if ($('.mdl-layout__drawer').hasClass('is-visible')) {
                $(".mdl-layout__drawer").css("left", 0);
            }
            else{
                $(".mdl-layout__drawer").css("left", -$("#Sidebar").outerWidth());
            }
        }

        function checkForSmallScreen()
        {
            if ($('.mdl-layout').hasClass('is-small-screen')){
                 margin_small_adjust();
                 //alert("small!!!");
            }
            else
                margin_adjust();
                setTimeout(checkForSmallScreen, 200);
        }

        function new_Gen_Var() {
            var outer = document.getElementById("Vars");
            var table = document.getElementById("var_body");
            var row = table.insertRow();

            // checkbox cell
            var check = row.insertCell();
            var checkbox = '<label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect mdl-data-table__select" for="var_row_fake[' + var_gen_num + ']"><input type="checkbox" id="var_row_fake[' + var_gen_num + ']" class="mdl-checkbox__input" /></label>';
            check.innerHTML = checkbox;
            // num cell
            var cell = row.insertCell();
            cell.className = "mdl-data-table__cell";
            cell.textContent = "local" + var_gen_num;
            // content cell
            var cell = row.insertCell();
            cell.className = "mdl-data-table__cell--non-numeric";
            cell.textContent = "local varname" + var_gen_num;
            // block cell
            var cell = row.insertCell();
            cell.className = "mdl-data-table__cell";
            cell.textContent = "###";
            var_gen_num++;
            console.log("new width:", $("#Sidebar").outerWidth());

            componentHandler.upgradeDom();
            checkForSmallScreen();
            cell.scrollIntoView();
        }

        function truncString(word) {

            var length = 20;
            var trimmedString = word.length > length ?
                    word.substring(0, length - 3) + "..." :
                    word;
            return trimmedString;
            }


        function new_Var(list, block_num) {
            var outer = document.getElementById("Vars");
            var table = document.getElementById("var_body");
            for(i = 0; i < list.length; i++){
                var row = table.insertRow();
                // checkbox cell
                var check = row.insertCell();
                var checkbox = '<label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect mdl-data-table__select" for="file_row[' + var_num + ']"><input type="checkbox" id="file_row[' + var_num + ']" class="mdl-checkbox__input" /></label>';
                check.innerHTML = checkbox;
                // num cell
                var cell = row.insertCell();
                cell.className = "mdl-data-table__cell";
                cell.textContent = var_num;
                // content cell
                var cell = row.insertCell();
                cell.className = "mdl-data-table__cell--non-numeric";

                cell.textContent = truncString(list[i]);
                cell.title = list[i];
                // block cell
                var cell = row.insertCell();
                cell.className = "mdl-data-table__cell";
                cell.textContent = block_num;
                var_num++;
            }
            componentHandler.upgradeDom();
            checkForSmallScreen();
        }

        function file_list(data, update = false) {
            var outer = document.getElementById("Files");
            var table = document.getElementById("files_body");
            var list = data.files;
            file_num = 0;
            if(update) {
                table.innerHTML = "";
            }
            for(i = 0; i < list.length; i++){
                var row = table.insertRow();
                // checkbox cell
                var check = row.insertCell();
                var checkbox = '<label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect mdl-data-table__select" for="row[' + file_num + ']"><input type="checkbox" id="row[' + file_num + ']" class="mdl-checkbox__input" /></label>';
                check.innerHTML = checkbox;
                // num cell
                var cell = row.insertCell();
                cell.className = "mdl-data-table__cell";
                cell.textContent = file_num;
                // content cell
                var cell = row.insertCell();
                cell.className = "mdl-data-table__cell--non-numeric";

                cell.textContent = truncString(list[i]);
                cell.title = list[i];
                // block cell
                var cell = row.insertCell();
                cell.className = "mdl-data-table__cell";
                file_num++;
            }

            componentHandler.upgradeDom();
            checkForSmallScreen();
        }

        socket.onmessage = function(e) {
            console.log(e.data);
            data = JSON.parse(e.data);
            console.log(data.type);

            // maybe somewhere else


            if (data.type == "block") {
                if(init){
                    init = false;
                    document.getElementById("progress").remove();
                }
                //new_block(data);
                new_grid_block(data);
            }
            else if (data.type == "cmd") {
                if(data.cmd == "reset"){
                    reset();
                }
                else if(data.cmd == "ready") {
                    if(init)
                        socket.send(JSON.stringify({"type": "command", "cmd": "init"}));
                }
                else if(data.cmd == "init_done") {
                    init = false;
                    document.getElementById("progress").remove();
                }
                else if(data.cmd == "light_up") {
                    light_up(data);
                }
                else if(data.cmd == "show") {
                    showBlock(data);
                }
                else if(data.cmd == "file_list") {
                    file_list(data);
                }
                else if(data.cmd == "file_list_update") {
                    file_list(data, update=true);
                }
            }

            plumbing.draggable($(".draggable") , {
                containment:"plumbing_block"
            });

        }

        socket.onopen = function(e){
            console.log("socket is open");
        };

        $( document ).ready(function() {
            console.log( "ready!" );

            // var header select
            var table_vars = document.getElementById("Vars");
            var headerCheckbox_vars = table_vars.querySelector('thead .mdl-data-table__select input');
            var headerCheckHandler_vars = function(event) {
                console.log("main checkbox clicked");
                var boxes = table_vars.querySelectorAll('tbody .mdl-data-table__select');
                if (event.target.checked) {
                    for (var i = 0, length = boxes.length; i < length; i++) {
                        boxes[i].MaterialCheckbox.check();
                        //boxes[i].MaterialCheckbox.updateClasses();
                    }
                } else {
                    for (var i = 0, length = boxes.length; i < length; i++) {
                        boxes[i].MaterialCheckbox.uncheck();
                        //boxes[i].MaterialCheckbox.updateClasses();
                    }
                }
            };
            headerCheckbox_vars.addEventListener('change', headerCheckHandler_vars);

            // file header select
            var table_files = document.getElementById("Files");
            var headerCheckbox_files = table_files.querySelector('thead .mdl-data-table__select input');
            var headerCheckHandler_files = function(event) {
                console.log("main checkbox clicked");
                var boxes = table_files.querySelectorAll('tbody .mdl-data-table__select');
                if (event.target.checked) {
                    for (var i = 0, length = boxes.length; i < length; i++) {
                        boxes[i].MaterialCheckbox.check();
                        //boxes[i].MaterialCheckbox.updateClasses();
                    }
                } else {
                    for (var i = 0, length = boxes.length; i < length; i++) {
                        boxes[i].MaterialCheckbox.uncheck();
                        //boxes[i].MaterialCheckbox.updateClasses();
                    }
                }
            };
            headerCheckbox_files.addEventListener('change', headerCheckHandler_files);

            console.log("new header width:", $("#Sidebar").outerWidth());
            console.log("header margin: ", $(".mdl-layout__header").css.marginLeft);
            $(checkForSmallScreen);
        });


    </script>
{% endblock %}

{% block body %}

    <!-- MDL Layout -->

    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-drawer
                mdl-layout--fixed-header">
        <header id="header-block" class="mdl-layout__header">
            <div class="mdl-layout__header-row">
                <span class="mdl-layout-title">Live ALEXA</span>
                <div class="mdl-layout-spacer"></div>
                <a href="http://b2slab.upc.edu/"><img class="logo" src={% static "AlexaHandler/logo.png" %}></a>
            </div>
            <div class="mdl-layout__header-row">
                <!-- Accent-colored raised button with ripple -->
                <button onclick="send_reset()" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored">
                    Reset
                </button>
                <button onclick="send_populate_hist()" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
                    Hist
                </button>
                <button onclick="send_populate_msg()" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
                    Msg
                </button>
                <button onclick="new_Gen_Var()" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
                    Var
                </button>
                <button onclick="send_image_populate()" class="mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab mdl-button--colored">
                    <i class="material-icons">add</i>
                </button>
                <div class="mdl-layout-spacer"></div>
            </div>
        </header>
        <div id ="Sidebar" class="mdl-layout__drawer">
            <span class="mdl-layout-title">Variables</span>
            <table id="Vars" class="var-list mdl-data-table mdl-shadow--2dp mdl-js-data-table">
                <thead>
                <tr>
                    <th>
                        <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect mdl-data-table__select" for="main-check">
                            <input type="checkbox" id="main-check" class="mdl-checkbox__input" />
                        </label>
                    </th>
                    <th class="mdl-data-table__cell">#Var</th>
                    <th class="mdl-data-table__cell--non-numeric">Name</th>
                    <th class="mdl-data-table__cell">#Block</th>
                </tr>
                </thead>

                <tbody id="var_body">

                </tbody>
            </table>

            <span class="mdl-layout-title">Available Files</span>
            <table id="Files" class="var-list mdl-data-table mdl-shadow--2dp mdl-js-data-table">
                <thead>
                <tr>
                    <th>
                        <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect mdl-data-table__select" for="main-check-files">
                            <input type="checkbox" id="main-check-files" class="mdl-checkbox__input" />
                        </label>
                    </th>
                    <th class="mdl-data-table__cell">#File</th>
                    <th class="mdl-data-table__cell--non-numeric">Name</th>
                </tr>
                </thead>

                <tbody id="files_body">

                </tbody>
            </table>
        </div>



        <main class="mdl-layout__content">
            <div id ="plumbing_block">
                <!-- MDL Progress Bar with Indeterminate Progress -->

                <div id="progress" class="mdl-progress mdl-js-progress mdl-progress__indeterminate" style="top:30%; left: 20%"></div>
                <div id="grid" class="mdl-grid">

                </div>
            </div>
        </main>
    </div>

{% endblock %}
