{% extends "AlexaHandler/base.html" %}
{% load static %}

{% block head %}

<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

<style>
    .draggable { width: 150px;
        height: 150px;
        adding: 0.5em;
        position:absolute;
        z-index: 10;
        overflow : hidden;}

    .window { z-index:20; }
    .jtk-connector { z-index:4; }
    .jtk-endpoint { z-index:11; }
    .jtk-overlay { z-index:12; }

    #content { width: 150px; height: 150px; padding: 0.5em; }
</style>
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

<script src="{% static "AlexaHandler/jsplumb.js" %}"></script>

<script type="text/javascript">

var plumbing = jsPlumb.getInstance();
var last_name = "";
var grid_count = 0;
var width = $(window).width();
var height = $(window).height();
var xGrid = Math.floor((width-150)/200);

plumbing.importDefaults({
  ConnectionsDetachable:false,
  ReattachConnections:true
});
// make containment specific

var dynamicAnchors = ["Left", "Right", "Top", "Bottom"];

var common = {detachable:false,
              anchor:dynamicAnchors,
              connector: ["Bezier", {
                            curviness:50,
              }],
              endpoint:[ "Rectangle", {
                cssClass:"myEndpoint",
                width:10,
                height:10
              }],};

function new_plumb(){
  //jsPlumb block
  console.log("new_plumb started");
  plumbing.draggable($(".draggable"));
}

var socket = new WebSocket("ws://" + window.location.host + "/alexa/");
var msg_count = 0;
var block_count = 0;
socket.onmessage = function(e) {
	console.log(e.data);
	data = JSON.parse(e.data);
	console.log(data.type);

  if(data.type=="init"){
	//box = document.getElementById("content");
    // get all Flows and map flowIDs to ids

    $.each(data.NodeFlows, function(i, v) {
        var flowID = v.FlowID;
        var ID = v.id;
        console.log("value: ", flowID, " ", ID);
        var name = "draggable_" + flowID;
        //ID_map[ID] = flowID;
        document.getElementById("plumbing block").innerHTML += "<div id=" + name + " class='draggable ui-widget-content' style='left: " + (grid_count%xGrid)*200 + "; top: " + (150 + Math.floor(grid_count/xGrid)*200) + "'><p>" + flowID + "<br>" + "</p></div>";
        name = "draggable_" + flowID;
        grid_count += 1;
        if(last_name != ""){
          plumbing.connect({
            source:name,
            target:last_name,
          }, common);
        }
        last_name = name;
    });
    // put nodes in the flows

  	//alert(e.data);
    new_plumb();
  }


  else if(data.type=="content_update"){
    console.log("update called");
    console.log("JSON", data);
    name = "draggable_" + "msg" + msg_count;
    msg_count += 1;
    console.log(xGrid, grid_count);
    document.getElementById("plumbing block").innerHTML += "<div id=" + name + " class='draggable ui-widget-content' style='left: " + (grid_count%xGrid)*200 + " ; top: " + (150 + Math.floor(grid_count/xGrid)*200) + "'><p>" + data.msg + "<br>" + "</p></div>";
    grid_count += 1;
    plumbing.connect({
      source:last_name,
      target:name,
    }, common);
    last_name = name;
  }

  else if(data.type=="block"){
    console.log("update called");
    console.log("JSON", data);
    name = "draggable_" + "block" + block_count;
    block_count += 1;
    console.log(xGrid, grid_count);
    document.getElementById("plumbing block").innerHTML += "<div id=" + name + " class='draggable ui-widget-content' style='left: " + (grid_count%xGrid)*200 + " ; top: " + (150 + Math.floor(grid_count/xGrid)*200) + "'>" + data.block_type + "<p>" + data.block_id + "<br>" + data.msg + "</p></div>";
    console.log("name", name);
    document.getElementById(name).innerHtml += "<p>" + data.block_name + "<br>" + data.msg + "</p>";
    grid_count += 1;
    plumbing.connect({
      source:last_name,
      target:name,
    }, common);
    last_name = name;
  }

  plumbing.draggable($(".draggable"));
  //jsPlumb.repaintEverything();

}



</script>
{% endblock %}

{% block body %}
<h1> LIVE ALEXA Test</h1>
<div id="plumbing block">
plumbing
</div>
{% endblock %}
